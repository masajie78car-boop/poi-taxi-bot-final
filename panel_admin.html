<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel Admin - POI Taxi (Multi Lokasi)</title>
  <style>
    :root{--bg:#f2f6fb;--card:#fff;--accent:#007bff}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:#222}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    header{display:flex;align-items:center;justify-content:space-between;background:var(--accent);color:#fff;padding:14px;border-radius:10px}
    header h1{margin:0;font-size:18px}
    .logout{background:#e74c3c;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .top-row{display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .select-loc{padding:8px;border-radius:8px;border:1px solid #dde6f2;background:#fff}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 4px 18px rgba(10,10,10,0.06);margin-top:12px}
    .stats{display:flex;gap:12px;flex-wrap:wrap}
    .stat{flex:1;min-width:140px;padding:12px;border-radius:8px;background:#fff;text-align:center}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border:1px solid #e7eef8;text-align:center;font-size:14px}
    th{background:#f4f9ff}
    .btn{padding:6px 8px;border-radius:8px;border:none;cursor:pointer}
    .btn-aktif{background:#28a745;color:#fff}
    .btn-naik{background:#17a2b8;color:#fff}
    .btn-hapus{background:#dc3545;color:#fff}
    @media(max-width:800px){
      header h1{font-size:16px}
      th,td{font-size:12px;padding:6px}
      .stat{padding:10px}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üè¢ ANTRIAN - POI Taxi (Multi Lokasi)</h1>
      <button class="logout" onclick="logout()">üö™ Logout</button>
    </header>

    <div class="top-row">
      <label for="lokasi">Pilih Lokasi:</label>
      <select id="lokasi" class="select-loc">
        <option value="mall_nusantara">Mall Nusantara</option>
        <option value="mall_asia">Mall Asia</option>
        <option value="stasiun_duren">Stasiun Duren</option>
      </select>
    </div>

    <div class="card">
      <div class="stats">
        <div class="stat"><div id="totalAktif">0</div><div>Total Aktif (Lobby)</div></div>
        <div class="stat"><div id="totalBuffer">0</div><div>Buffer (Menunggu)</div></div>
        <div class="stat"><div id="avgWait">-</div><div>Rata-rata Tunggu</div></div>
      </div>

      <h3 style="margin-top:12px">üöñ Lobby (Aktif)</h3>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>No</th><th>No Polisi</th><th>No Lambung</th><th>Status</th><th>Aksi</th></tr></thead>
          <tbody id="tabelAktif"><tr><td colspan="5">Memuat...</td></tr></tbody>
        </table>
      </div>

      <h3 style="margin-top:18px">üïí Buffer (Menunggu)</h3>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>No</th><th>No Polisi</th><th>No Lambung</th><th>Status</th><th>Aksi</th></tr></thead>
          <tbody id="tabelBuffer"><tr><td colspan="5">Memuat...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getDatabase, ref, onValue, update, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyArjIuAyCRw85LStoiJzgIdLyhs8HXPFhs",
      authDomain: "poi-taxi.firebaseapp.com",
      databaseURL: "https://poi-taxi-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "poi-taxi",
      storageBucket: "poi-taxi.firebasestorage.app",
      messagingSenderId: "774582687333",
      appId: "1:774582687333:web:ee95e1e3e705beaee4d88c"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
      if (!user) window.location.href = "login.html";
    });

    const lokasiSelect = document.getElementById("lokasi");
    const tabelAktif = document.getElementById("tabelAktif");
    const tabelBuffer = document.getElementById("tabelBuffer");
    const totalAktif = document.getElementById("totalAktif");
    const totalBuffer = document.getElementById("totalBuffer");
    const avgWait = document.getElementById("avgWait");

    const WHATSAPP_TOKEN = "EAAUzJvcgTvwBP4MgkCHstWa8iZB8AyxgyAjUIEdVtAbLKWx3BP3ik5wBofGaO3YGWZC0Uqo9O4KngKfwblY4WYosMih2513mkn82mir8OZAXeCX8T1npg3tDiZAIFunhkY9SGekZCtZCAN29zE2dRne808pl3l2O85xGarHvVgbZCv3TMtNCuX55ADgKAxbAgZDZD";
    const PHONE_NUMBER_ID = "905097019346311";

    function kirimPesan(nomor, teks) {
      return fetch(`https://graph.facebook.com/v19.0/${PHONE_NUMBER_ID}/messages`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${WHATSAPP_TOKEN}`, "Content-Type": "application/json" },
        body: JSON.stringify({ messaging_product: "whatsapp", to: nomor, text: { body: teks } })
      });
    }

    function loadData(lokasi) {
      const db = getDatabase();
      const antrianRef = ref(db, `pangkalan/${lokasi}/antrian`);
      onValue(antrianRef, (snap) => {
        const data = snap.val() || {};
        const arr = Object.entries(data).sort((a,b)=> new Date(a[1].createdAt)-new Date(b[1].createdAt));
        const aktif = arr.filter(([_,v])=> v.status === "aktif");
        const buffer = arr.filter(([_,v])=> v.status === "buffer");

        // stats
        totalAktif.textContent = aktif.length;
        totalBuffer.textContent = buffer.length;
        if (arr.length===0) avgWait.textContent = "-"; else {
          const totalMs = arr.reduce((s,[,v])=> s + (Date.now() - new Date(v.createdAt).getTime()), 0);
          avgWait.textContent = Math.round((totalMs/arr.length)/60000) + " menit";
        }

        // render aktif
        tabelAktif.innerHTML = "";
        aktif.forEach(([key,v],i)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${i+1}</td><td>${v.noPolisi}</td><td>${v.noLambung}</td><td>${v.status}</td><td>
            <button class="btn btn-aktif" data-id="${key}">‚úÖ Selesai</button></td>`;
          tabelAktif.appendChild(tr);
        });
        if (aktif.length===0) tabelAktif.innerHTML = "<tr><td colspan='5'>Tidak ada aktif</td></tr>";

        // render buffer
        tabelBuffer.innerHTML = "";
        buffer.forEach(([key,v],i)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${aktif.length + i + 1}</td><td>${v.noPolisi}</td><td>${v.noLambung}</td><td>${v.status}</td><td>
            <button class="btn btn-naik" data-id="${key}">‚¨ÜÔ∏è Naik ke Lobby</button></td>`;
          tabelBuffer.appendChild(tr);
        });
        if (buffer.length===0) tabelBuffer.innerHTML = "<tr><td colspan='5'>Tidak ada buffer</td></tr>";

        // attach buttons
        document.querySelectorAll(".btn-aktif").forEach(b=> b.addEventListener("click", async (e)=>{
          const id = e.target.getAttribute("data-id");
          // remove aktif
          await remove(ref(getDatabase(), `pangkalan/${lokasi}/antrian/${id}`));
          // promote first buffer if exists
          if (buffer.length>0) {
            const [firstKey, firstData] = buffer[0];
            await update(ref(getDatabase(), `pangkalan/${lokasi}/antrian/${firstKey}`), { status: "aktif" });
            // notify driver
            if (firstData.nomor) {
              await kirimPesan(firstData.nomor, `üöï ${firstData.noPolisi} | ${firstData.noLambung}\nSilakan masuk Lobby ${lokasi.replace(/_/g,' ')}.\nGiliran Anda berikutnya.`);
            }
          }
        }));

        document.querySelectorAll(".btn-naik").forEach(b=> b.addEventListener("click", async (e)=>{
          const id = e.target.getAttribute("data-id");
          const data = buffer.find(([k])=> k===id)[1];
          await update(ref(getDatabase(), `pangkalan/${lokasi}/antrian/${id}`), { status: "aktif" });
          if (data && data.nomor) {
            await kirimPesan(data.nomor, `üöï ${data.noPolisi} | ${data.noLambung}\nSilakan masuk Lobby ${lokasi.replace(/_/g,' ')}.\nGiliran Anda berikutnya.`);
          }
        }));
      });
    }

    // init
    loadData(lokasiSelect.value);
    lokasiSelect.addEventListener("change", ()=> loadData(lokasiSelect.value));

    window.logout = async function() {
      try {
        await signOut(auth);
        window.location.href = "login.html";
      } catch(e) {
        alert("Logout gagal: "+ e);
      }
    };
  </script>
</body>
</html>
